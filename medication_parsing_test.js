const PATIENT_WITH_MCG_AND_DECIMAL = `Request issued 230713 by Prac: 91/13865 (Marazzi)    Logon ID: TEST_1234
0 Operation successful
 

Med reconciliation
1234 123 123 - JOHN E DOE - 1992 Jan 01 - Male
Please check the medications you want included on the report,
then click the Continue Button.
Drugs are listed in alphabetic order

NOTE: By default only current medications are automatically selected

 Check here to include all prescriptions on the report

      Continue
01938088


	ACETAMINOPHEN    325 MG TABLET
Jamp Acetaminophen 325   JAMP PHARMA CO
Dispensed: 2023 Jul 12 Status:Filled
Qty: 6.0 Duration: 1
*DAILY DISPENSE* TAKE 2 TABLETS ORALLY THREE TIMES DAILY
02487381


	APIXABAN    2.5 MG TABLET
Apo-Apixaban   APOTEX INC
Dispensed: 2023 Jul 12 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY
02487403
		APIXABAN    5 MG TABLET
Apo-Apixaban   APOTEX INC
Dispensed: 2023 Apr 25 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY
02489236
		APIXABAN    5 MG TABLET
Sandoz Apixaban Sdz   SANDOZ CANADA
Dispensed: 2023 Feb 24 Status:Filled
Qty: 60.0 Duration: 30
TAKE 1 TABLET TWICE DAILY (AT 8AM AND 8PM)
02245916
		CARVEDILOL    12.5 MG TABLET
Pms-Carvedilol   PHARMASCIENCE
Dispensed: 2023 Jan 27 Status:Filled
Qty: 90.0 Duration: 90
TAKE 1/2 TABLET TWICE A DAY
02245916
		CARVEDILOL    12.5 MG TABLET
Pms-Carvedilol   PHARMASCIENCE
Dispensed: 2023 Feb 24 Status:Filled
Qty: 30.0 Duration: 30
TAKE 1/2 TABLET TWICE A DAY WITH FOOD
66123252
		COMPOUNDED PREP (PHARMACARE NO   
Compounded Prep (Pharmacare Non-Benefit)   UNKNOWN
Dispensed: 2023 May 15 Status:Filled
Qty: 400.0 Duration: 14
(ACETAMINOPHEN 100MG/ML ) (SHAKE WELL ) THEN GIVE 6.5 MILLILITERS (=650MG) FOU
02531410


	DAPAGLIFLOZIN    10 MG TABLET
AURO PHARMA IN
Dispensed: 2023 Jul 12 Status:Filled
Qty: 1.0 Duration: 1
* DAILY DISPENSE* TAKE ONE TABLET ORALLY ONCE DAILY ( NEW MED)
02335700
		DIGOXIN    0.0625 MG TABLET
Pms-Digoxin   PHARMASCIENCE
Dispensed: 2023 Feb 24 Status:Filled
Qty: 30.0 Duration: 30
TAKE 1 TABLET ONCE A DAY
02335719


	DIGOXIN    0.125 MG TABLET
Pms-Digoxin   PHARMASCIENCE
Dispensed: 2023 Jul 11 Status:Filled
Qty: 1.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY ONCE DAILY
02466759
		FUROSEMIDE    20 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Apr 25 Status:Filled
Qty: 3.0 Duration: 1
*DAILY DISPENSE* TAKE 3 TABLETS ORALLY ONCE DAILY
02466759


	FUROSEMIDE    20 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Jul 12 Status:Filled
Qty: 3.0 Duration: 1
*DAILY DISPENSE* TAKE 3 TABLETS ORALLY ONCE DAILY (HOLD IF SBP LESS THAN 90 AND
02466759
		FUROSEMIDE    20 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Feb 24 Status:Filled
Qty: 60.0 Duration: 30
TAKE 1 TABLET TWICE DAILY
02466767
		FUROSEMIDE    40 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Jan 26 Status:Filled
Qty: 90.0 Duration: 90
TAKE 1 TABLET ONCE A DAY ( FOR FLUID RETENTION )
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 May 20 Status:Filled
Qty: 1.0 Duration: 1
(MAY 16 - JUNE 07 )DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NE
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 May 18 Status:Filled
Qty: 0.5 Duration: 1
(MAY 16 - JUNE 24)DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEE
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 May 04 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEEDED (4 DOSES IN S
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 Apr 26 Status:Filled
Qty: 1.5 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEEDED (PT ONLY WANT
02172062


	LEVOTHYROXINE SODIUM    25 MCG TABLET
Synthroid   BGP PHARMA ULC
Dispensed: 2023 Jul 12 Status:Filled
Qty: 1.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY ONCE DAILY {LEVOTHYROXINE}
99000501
		MEDICATION REVIEW STANDARD    
Medication Review Standard   UNKNOWN
Dispensed: 2023 May 12 Status:Filled
Qty: 1.0 Duration: 1
604-574-3331 MEDICATION REVIEW PHARMACITY DRUGSTORE #3 **(MR-S)**
02248855


	METOPROLOL TARTRATE    25 MG TABLET
Pms-Metoprolol-L   PHARMASCIENCE
Dispensed: 2023 Jul 11 Status:Filled
Qty: 1.0 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY TWICE DAILY
02384892
		NABILONE    1 MG CAPSULE
Teva-Nabilone   TEVA CANADA LI
Dispensed: 2023 Jun 17 Status:Filled
Qty: 30.0 Duration: 5
TAKE 1 OR 2 CAPSULES 3 TIMES A DAY
02384892
		NABILONE    1 MG CAPSULE
Teva-Nabilone   TEVA CANADA LI
Dispensed: 2023 May 19 Status:Filled
Qty: 30.0 Duration: 5
TAKE 1 OR 2 CAPSULES 3 TIMES A DAY AS NEEDED
02408570
		PANTOPRAZOLE MAGNESIUM    40 MG TABLET DR
Mylan-Pantoprazole T   MYLAN PHARMACE
Dispensed: 2023 May 19 Status:Filled
Qty: 30.0 Duration: 30
TAKE 1 TABLET ONCE A DAY
02316080


	QUETIAPINE FUMARATE    25 MG TABLET
Act Quetiapine   TEVA CANADA LI
Dispensed: 2023 Jul 12 Status:Filled
Qty: 0.5 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY AT BEDTIME
02446936


	SACUBITRIL/VALSARTAN    49 MG-51MG TABLET
Entresto   NOVARTIS PHARM
Dispensed: 2023 Jul 12 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY (SACUBATRIL/VALSARTAN)
02446944
		SACUBITRIL/VALSARTAN    97MG-103MG TABLET
Entresto   NOVARTIS PHARM
Dispensed: 2023 Jan 30 Status:Filled
Qty: 100.0 Duration: 50
TAKE 1 TABLET TWICE DAILY
02446944
		SACUBITRIL/VALSARTAN    97MG-103MG TABLET
Entresto   NOVARTIS PHARM
Dispensed: 2023 Feb 24 Status:Filled
Qty: 60.0 Duration: 30
TAKE 1 TABLET TWICE DAILY (START IF SYSTOLIC BLOOD PRESSURE IS GREATER THAN 100)
      Continue

 `

 const PATIENT_WITH_DECIMAL_AND_TEMP_DRUG = `Request issued 230713 by Prac: 91/13865 (TESTER)    Logon ID: TEST1234
0 Operation successful
 

Med reconciliation
1234 123 123 - MARY U DOE - 1955 Jan 02 - Female
Please check the medications you want included on the report,
then click the Continue Button.
Drugs are listed in alphabetic order

NOTE: By default only current medications are automatically selected

 Check here to include all prescriptions on the report

      Continue
02489236


	APIXABAN    5 MG TABLET
Sandoz Apixaban Sdz   SANDOZ CANADA
Dispensed: 2023 Jul 08 Status:Filled
Qty: 56.0 Duration: 28
TAKE 1 TABLET TWICE A DAY
02272873


	CARBIDOPA/LEVODOPA    25MG-100MG TABLET ER
Aa-Levocarb Cr   AA PHARMA INC.
Dispensed: 2023 Jul 08 Status:Filled
Qty: 140.0 Duration: 28
TAKE 1 TABLET ORALLY FOUR TIMES A DAY
02521261
		CEPHALEXIN    500 MG TABLET
Cephalexin   SANIS HEALTH
Dispensed: 2023 Apr 28 Status:Filled
Qty: 28.0 Duration: 7
TAKE 1 TABLET EVERY 6 HOURS FOR 7 DAYS
02335719


	DIGOXIN    0.125 MG TABLET
Pms-Digoxin   PHARMASCIENCE
Dispensed: 2023 Jul 08 Status:Filled
Qty: 28.0 Duration: 28
TAKE 1 TABLET ONCE DAILY
02516136


	DILTIAZEM HCL    240 MG CAP SA 24H
Diltiazem T   SANIS HEALTH
Dispensed: 2023 Jul 08 Status:Filled
Qty: 28.0 Duration: 28
TAKE 1 CAPSULE ORALLY ONCE DAILY
02351420


	FUROSEMIDE    20 MG TABLET
Furosemide   SANIS HEALTH
Dispensed: 2023 Jul 09 Status:Filled
Qty: 28.0 Duration: 28
TAKE 1 TABLET ONCE DAILY
      Continue

 `

const MEDICATION_DOSAGE_REGEX = /\d+(\.\d+)?\s*(MCG|MG)|\d+\s*(MCG|MG)/g
const COMBO_PRODUCT_REGEX = /\b\w+\/\w+\b/;
function extractDosagesFromName(name){
    const matches = name.match(MEDICATION_DOSAGE_REGEX);
    if (matches && matches.length > 0) {
        return matches.reverse()
        .map(match => match.replace(/\s/g, ""))
        .map(dose => {
            return [dose, convertDosageUnit(dose)]
        })
        .flat()
    }
    return null;
}
function convertDosageUnit(dose){
    if(dose.includes("MG")){
        let num = Number(dose.replace(/MG/g, ""));
        if(num == NaN) return null;
        return (num * 1000).toString() + "MCG";
    }
    if(dose.includes("MCG")){
        let num = Number(dose.replace(/MCG/g, ""));
        if(num == NaN) return null;
        return (num / 1000).toString() + "MG";
    } 
    // console.log("Dosage does not contain MG or MCG: " + dose);
    return null;
}
function isComboProduct(medication){
    return COMBO_PRODUCT_REGEX.test(medication.Name) && medication.Name.match(MEDICATION_DOSAGE_REGEX)?.length == 2;
}
function extractFrequencyFromInstruction(instruction){
    if(instruction.includes("TAKE")){
        let partAfterTake = instruction.split("TAKE")[1];
        if(partAfterTake.includes("TABLET") || partAfterTake.includes("CAPSULE")){
            const pattern = /\b(?:TABLET|TABLETS|CAPSULE|CAPSULES)\b/gi;
            let amount = partAfterTake.split(pattern)[0].trim();
            let partAfterItem = partAfterTake.split(pattern)[1];
            if(partAfterItem.includes("A DAY") || partAfterItem.includes("DAILY")){
                let partBefore = undefined;
                if(partAfterItem.split("DAILY").length > 0){
                    partBefore = partAfterItem.split("DAILY")[0];
                } else {
                    partBefore = partAfterItem.split("A DAY")[0];
                }
                if(partBefore.includes("ONCE")){ return amount + " - Daily"; }
                if(partBefore.includes("TWICE")){ return amount + " - BID"; }
                if(partBefore.includes("THREE")){ return amount + " - TID"; }
                if(partBefore.includes("FOUR")){ return amount + " - QID"; }
                if(partBefore.includes("1")){ return amount + " - Daily"; }
                if(partBefore.includes("2")){ return amount + " - BID"; }
                if(partBefore.includes("3")){ return amount + " - TID"; }
                if(partBefore.includes("4")){ return amount + " - QID"; }
                if(partBefore.includes("AS NEEDED")){ return amount + " - PRN"; }
            }
            return amount + " - Daily"
        }
    }
    return "Variable dose";
}

function extractFrequencyFromInstructionTest(){

    let frequencies = [
        { input: '*DAILY DISPENSE* TAKE 2 TABLETS ORALLY THREE TIMES DAILY', expected: '2 - TID' },
        { input: '*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY', expected: '1 - BID' },
        { input: 'TAKE 1 TABLET TWICE DAILY (AT 8AM AND 8PM)', expected: '1 - BID' },
        { input: 'TAKE 1/2 TABLET TWICE A DAY', expected: '1/2 - BID' },
        { input: 'TAKE 1/2 TABLET TWICE A DAY WITH FOOD', expected: '1/2 - BID' },
        { input: '(ACETAMINOPHEN 100MG/ML ) (SHAKE WELL ) THEN GIVE 6.5 MILLILITERS (=650MG) FOU', expected: 'Variable dose' },
        { input: '* DAILY DISPENSE* TAKE ONE TABLET ORALLY ONCE DAILY ( NEW MED)', expected: 'ONE - Daily' },
        { input: 'TAKE 1 TABLET ONCE A DAY', expected: '1 - Daily' },
        { input: '*DAILY DISPENSE* TAKE 1 TABLET ORALLY ONCE DAILY', expected: '1 - Daily' },
        { input: '*DAILY DISPENSE* TAKE 3 TABLETS ORALLY ONCE DAILY', expected: '3 - Daily' },
        { input: '*DAILY DISPENSE* TAKE 3 TABLETS ORALLY ONCE DAILY (HOLD IF SBP LESS THAN 90 AND', expected: '3 - Daily' },
        { input: 'TAKE 1 TABLET TWICE DAILY', expected: '1 - BID' },
        { input: 'TAKE 1 TABLET ONCE A DAY ( FOR FLUID RETENTION )', expected: '1 - Daily' },
        { input: '(MAY 16 - JUNE 07 )DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NE', expected: '1/2 - QID' },
        { input: '(MAY 16 - JUNE 24)DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEE', expected: '1/2 - QID' },
        { input: '*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEEDED (4 DOSES IN S', expected: '1/2 - QID' },
        { input: '*DAILY DISPENSE* TAKE 1 TABLET ORALLY ONCE DAILY {LEVOTHYROXINE}', expected: '1 - Daily' },
        { input: '04-574-3331 MEDICATION REVIEW PHARMACITY DRUGSTORE #3 **(MR-S)**', expected: 'Variable dose' },
        { input: '*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY TWICE DAILY', expected: '1/2 - BID' },
        { input: 'TAKE 1 OR 2 CAPSULES 3 TIMES A DAY AS NEEDED', expected: '1 OR 2 - TID' },
        { input: 'TAKE 1 TABLET ONCE A DAY', expected: '1 - Daily' },
        { input: '*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY (SACUBATRIL/VALSARTAN)', expected: '1 - BID' }, // { input: 'TAKE 1 TABLET TWICE DAILY', expected: '1 - BID' },
        { input: 'TAKE 1 TABLET TWICE DAILY (START IF SYSTOLIC BLOOD PRESSURE IS GREATER THAN 100)', expected: '1 - BID' },
        { input: 'TAKE 1 OR 2 CAPSULES 3 TIMES A DAY', expected: '1 OR 2 - TID' },
        { input: '*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY AT BEDTIME', expected: '1/2 - Daily' },
        { input: 'RNDOM SJKJDFKS', expected: 'Variable dose' },
        { input: '', expected: 'Variable dose' },
        { input: 'DAILY DAILY DAILY', expected: 'Variable dose' },
        { input: 'ONCE', expected: 'Variable dose' },
        { input: 'TAKE', expected: 'Variable dose' },
    ]
    return test("extractFrequencyFromInstructionTest", frequencies, extractFrequencyFromInstruction);
}
function convertDosageUnitTest(){
    let testCases = [
        { input: "23MG", expected: "23000MCG" },
        { input: "2.3MG", expected: "2300MCG" },
        { input: "23MCG", expected: "0.023MG" },
        { input: "2.3MCG", expected: "0.0023MG" },
        { input: "2.3M", expected: null },
        { input: "M", expected: null },
        { input: "0.4MG", expected: "400MCG" },
    ]
    return test("convertDosageUnitTest", testCases, convertDosageUnit)
}
function extractDosagesFromNameTest(){
    let testCases = [
        { input: 'DIGOXIN    0.125 MG TABLET', expected: ['0.125MG', '125MCG'] },
        { input: '	LEVOTHYROXINE SODIUM    25 MCG TABLET', expected: ['25MCG', '0.025MG'] },
        { input: 'DILTIAZEM HCL    240 MG CAP SA 24H', expected: ['240MG', '240000MCG'] },
        { input: 'BOBOB  29.8 MCG', expected: ['29.8MCG', '0.0298MG'] },
        { input: 'BOBOB  2.98 MCG*43MG', expected: ['43MG','43000MCG','2.98MCG','0.00298MG'] },
        // { input: 'JFKDSJFK 2222222.0 MG', expected: '2222222.0MG' },
        // { input: '10 MG fjdkls fjkdlsajfkls', expected: '10MG' },
        // { input: 'jkfdlsa fdkjlaf dsl 10.8 MCG', expected: '10.8MCG' },
        // { input: 'fdsjaklfds 22.9 MG 32890jfksfds kfsj ', expected: '22.9MG' },
        { input: '23490 9230439 27.8 MG-77MCG89089kflds 99', expected: ['77MCG', '0.077MG', '27.8MG','27800MCG'] },
        // { input: '18.9 MCG 19 MG', expected: '18.9MCG' },
        // { input: '18.9 19 MG', expected: '19MG' },
        // { input: '1MG', expected: '1MG' },
        // { input: '19MCG', expected: '19MCG' },
        { input: '23490 9230439 27.8 MR 89089kflds 99', expected: null },
        { input: 'jkflfkdslfds jfdksalfjkds 898989 jkfdsjakfd', expected: null },
        { input: ' . MG fkslfljds fsdafds', expected: null },
        { input: '', expected: null },
        { input: '     ', expected: null },
        { input: 'MG', expected: null },
        { input: 'MCG', expected: null },
    ]
    return test('extractDosagesFromNameTest', testCases, extractDosagesFromName);
}

function isComboProductTest(){
    let testCases = [
        { input: { Name: '	SACUBITRIL/VALSARTAN    49 MG-51MG TABLET' }, expected: true },
        { input: { Name: '	CARBIDOPA/LEVODOPA    25MG-100MG TABLET ER' }, expected: true },
        { input: { Name: '	SACUBITRILVALSARTAN    49 MG-51MG TABLET' }, expected: false },
        { input: { Name: '	SAC/UBITRILVALSARTAN    49 M9-51MG TABLET' }, expected: false },
        { input: { Name: '' }, expected: false },
    ]
    return test('isComboProductTest', testCases, isComboProduct);
}

function test(testName, testCases, func){
    let fail = false;
    for (let i = 0; i < testCases.length; i++) {
        let test = testCases[i];
        let actual = func(test.input)
        if(JSON.stringify(actual) !== JSON.stringify(test.expected)){
             console.log(testName + " FAILED! Expected: " + test.expected + " but actual: " + actual + "\nFor input: " + JSON.stringify(test));
             fail = true;
        }
    }
    if(fail) return testName + "FAILED!";
    else return testName + " PASSED!"
}

console.log(extractDosagesFromNameTest());
console.log(isComboProductTest());
console.log(convertDosageUnitTest());
console.log(extractFrequencyFromInstructionTest());