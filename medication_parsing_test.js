const PATIENT_WITH_MCG_AND_DECIMAL = `Request issued 230713 by Prac: 91/13865 (Marazzi)    Logon ID: TEST_1234
0 Operation successful
 

Med reconciliation
1234 123 123 - JOHN E DOE - 1992 Jan 01 - Male
Please check the medications you want included on the report,
then click the Continue Button.
Drugs are listed in alphabetic order

NOTE: By default only current medications are automatically selected

 Check here to include all prescriptions on the report

      Continue
01938088


	ACETAMINOPHEN    325 MG TABLET
Jamp Acetaminophen 325   JAMP PHARMA CO
Dispensed: 2023 Jul 12 Status:Filled
Qty: 6.0 Duration: 1
*DAILY DISPENSE* TAKE 2 TABLETS ORALLY THREE TIMES DAILY
02487381


	APIXABAN    2.5 MG TABLET
Apo-Apixaban   APOTEX INC
Dispensed: 2023 Jul 12 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY
02487403
		APIXABAN    5 MG TABLET
Apo-Apixaban   APOTEX INC
Dispensed: 2023 Apr 25 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY
02489236
		APIXABAN    5 MG TABLET
Sandoz Apixaban Sdz   SANDOZ CANADA
Dispensed: 2023 Feb 24 Status:Filled
Qty: 60.0 Duration: 30
TAKE 1 TABLET TWICE DAILY (AT 8AM AND 8PM)
02245916
		CARVEDILOL    12.5 MG TABLET
Pms-Carvedilol   PHARMASCIENCE
Dispensed: 2023 Jan 27 Status:Filled
Qty: 90.0 Duration: 90
TAKE 1/2 TABLET TWICE A DAY
02245916
		CARVEDILOL    12.5 MG TABLET
Pms-Carvedilol   PHARMASCIENCE
Dispensed: 2023 Feb 24 Status:Filled
Qty: 30.0 Duration: 30
TAKE 1/2 TABLET TWICE A DAY WITH FOOD
66123252
		COMPOUNDED PREP (PHARMACARE NO   
Compounded Prep (Pharmacare Non-Benefit)   UNKNOWN
Dispensed: 2023 May 15 Status:Filled
Qty: 400.0 Duration: 14
(ACETAMINOPHEN 100MG/ML ) (SHAKE WELL ) THEN GIVE 6.5 MILLILITERS (=650MG) FOU
02531410


	DAPAGLIFLOZIN    10 MG TABLET
AURO PHARMA IN
Dispensed: 2023 Jul 12 Status:Filled
Qty: 1.0 Duration: 1
* DAILY DISPENSE* TAKE ONE TABLET ORALLY ONCE DAILY ( NEW MED)
02335700
		DIGOXIN    0.0625 MG TABLET
Pms-Digoxin   PHARMASCIENCE
Dispensed: 2023 Feb 24 Status:Filled
Qty: 30.0 Duration: 30
TAKE 1 TABLET ONCE A DAY
02335719


	DIGOXIN    0.125 MG TABLET
Pms-Digoxin   PHARMASCIENCE
Dispensed: 2023 Jul 11 Status:Filled
Qty: 1.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY ONCE DAILY
02466759
		FUROSEMIDE    20 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Apr 25 Status:Filled
Qty: 3.0 Duration: 1
*DAILY DISPENSE* TAKE 3 TABLETS ORALLY ONCE DAILY
02466759


	FUROSEMIDE    20 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Jul 12 Status:Filled
Qty: 3.0 Duration: 1
*DAILY DISPENSE* TAKE 3 TABLETS ORALLY ONCE DAILY (HOLD IF SBP LESS THAN 90 AND
02466759
		FUROSEMIDE    20 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Feb 24 Status:Filled
Qty: 60.0 Duration: 30
TAKE 1 TABLET TWICE DAILY
02466767
		FUROSEMIDE    40 MG TABLET
Mint-Furosemide   MINT PHARMACEU
Dispensed: 2023 Jan 26 Status:Filled
Qty: 90.0 Duration: 90
TAKE 1 TABLET ONCE A DAY ( FOR FLUID RETENTION )
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 May 20 Status:Filled
Qty: 1.0 Duration: 1
(MAY 16 - JUNE 07 )DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NE
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 May 18 Status:Filled
Qty: 0.5 Duration: 1
(MAY 16 - JUNE 24)DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEE
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 May 04 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEEDED (4 DOSES IN S
00885444
		HYDROMORPHONE HCL    1 MG TABLET
Pms-Hydromorphone Tab 1mg   PHARMASCIENCE
Dispensed: 2023 Apr 26 Status:Filled
Qty: 1.5 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY FOUR TIMES DAILY AS NEEDED (PT ONLY WANT
02172062


	LEVOTHYROXINE SODIUM    25 MCG TABLET
Synthroid   BGP PHARMA ULC
Dispensed: 2023 Jul 12 Status:Filled
Qty: 1.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY ONCE DAILY {LEVOTHYROXINE}
99000501
		MEDICATION REVIEW STANDARD    
Medication Review Standard   UNKNOWN
Dispensed: 2023 May 12 Status:Filled
Qty: 1.0 Duration: 1
604-574-3331 MEDICATION REVIEW PHARMACITY DRUGSTORE #3 **(MR-S)**
02248855


	METOPROLOL TARTRATE    25 MG TABLET
Pms-Metoprolol-L   PHARMASCIENCE
Dispensed: 2023 Jul 11 Status:Filled
Qty: 1.0 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY TWICE DAILY
02384892
		NABILONE    1 MG CAPSULE
Teva-Nabilone   TEVA CANADA LI
Dispensed: 2023 Jun 17 Status:Filled
Qty: 30.0 Duration: 5
TAKE 1 OR 2 CAPSULES 3 TIMES A DAY
02384892
		NABILONE    1 MG CAPSULE
Teva-Nabilone   TEVA CANADA LI
Dispensed: 2023 May 19 Status:Filled
Qty: 30.0 Duration: 5
TAKE 1 OR 2 CAPSULES 3 TIMES A DAY AS NEEDED
02408570
		PANTOPRAZOLE MAGNESIUM    40 MG TABLET DR
Mylan-Pantoprazole T   MYLAN PHARMACE
Dispensed: 2023 May 19 Status:Filled
Qty: 30.0 Duration: 30
TAKE 1 TABLET ONCE A DAY
02316080


	QUETIAPINE FUMARATE    25 MG TABLET
Act Quetiapine   TEVA CANADA LI
Dispensed: 2023 Jul 12 Status:Filled
Qty: 0.5 Duration: 1
*DAILY DISPENSE* TAKE 1/2 TABLET ORALLY AT BEDTIME
02446936


	SACUBITRIL/VALSARTAN    49 MG-51MG TABLET
Entresto   NOVARTIS PHARM
Dispensed: 2023 Jul 12 Status:Filled
Qty: 2.0 Duration: 1
*DAILY DISPENSE* TAKE 1 TABLET ORALLY TWICE DAILY (SACUBATRIL/VALSARTAN)
02446944
		SACUBITRIL/VALSARTAN    97MG-103MG TABLET
Entresto   NOVARTIS PHARM
Dispensed: 2023 Jan 30 Status:Filled
Qty: 100.0 Duration: 50
TAKE 1 TABLET TWICE DAILY
02446944
		SACUBITRIL/VALSARTAN    97MG-103MG TABLET
Entresto   NOVARTIS PHARM
Dispensed: 2023 Feb 24 Status:Filled
Qty: 60.0 Duration: 30
TAKE 1 TABLET TWICE DAILY (START IF SYSTOLIC BLOOD PRESSURE IS GREATER THAN 100)
      Continue

 `

 const PATIENT_WITH_DECIMAL_AND_TEMP_DRUG = `Request issued 230713 by Prac: 91/13865 (TESTER)    Logon ID: TEST1234
0 Operation successful
 

Med reconciliation
4567 111 222 - MARY U DOE - 1955 Jan 02 - Female
Please check the medications you want included on the report,
then click the Continue Button.
Drugs are listed in alphabetic order

NOTE: By default only current medications are automatically selected

 Check here to include all prescriptions on the report

      Continue
02489236


	APIXABAN    5 MG TABLET
Sandoz Apixaban Sdz   SANDOZ CANADA
Dispensed: 2023 Jul 08 Status:Filled
Qty: 56.0 Duration: 28
TAKE 1 TABLET TWICE A DAY
02272873


	CARBIDOPA/LEVODOPA    25MG-100MG TABLET ER
Aa-Levocarb Cr   AA PHARMA INC.
Dispensed: 2023 Jul 08 Status:Filled
Qty: 140.0 Duration: 28
TAKE 1 TABLET ORALLY FOUR TIMES A DAY
02521261
		CEPHALEXIN    500 MG TABLET
Cephalexin   SANIS HEALTH
Dispensed: 2023 Apr 28 Status:Filled
Qty: 28.0 Duration: 7
TAKE 1 TABLET EVERY 6 HOURS FOR 7 DAYS
02335719


	DIGOXIN    0.125 MG TABLET
Pms-Digoxin   PHARMASCIENCE
Dispensed: 2023 Jul 08 Status:Filled
Qty: 28.0 Duration: 28
TAKE 1 TABLET ONCE DAILY
02516136


	DILTIAZEM HCL    240 MG CAP SA 24H
Diltiazem T   SANIS HEALTH
Dispensed: 2023 Jul 08 Status:Filled
Qty: 28.0 Duration: 28
TAKE 1 CAPSULE ORALLY ONCE DAILY
02351420


	FUROSEMIDE    20 MG TABLET
Furosemide   SANIS HEALTH
Dispensed: 2023 Jul 09 Status:Filled
Qty: 28.0 Duration: 28
TAKE 1 TABLET ONCE DAILY
      Continue

 `

function parseMedicalData(dataString) {
    function parseMedicationLines(isCurrent, lines){
        const medication = {
            current: isCurrent,
            DIN: undefined,
            Name: undefined,
            Instruction: undefined
        };
        medication.DIN = lines[0].trim();
        medication.Name = lines[1].trim();
        medication.Instruction = lines[5].trim();
        return medication;
    }

    //Given the input string split into lines, return true if represents data copied form Pharmanet data, false otherwise
    function isValidMedicalData(lines){
        return (lines && lines.length > 0 && lines[0].trim().startsWith("Request issued") && lines.length > 13);
    }

    const CURRENT_MR_LENGTH = 8;
    const NON_CURRENT_MR_LENGTH = 6;
    function isDINOrContinue(string) {
        let trimmed = string.trim();
        return /^\d+$/.test(trimmed) || trimmed === 'Continue';
    }

    const medicalData = {
        PHN: '',
        name: '',
        birthDate: '',
        gender: '',
        medications: []
    };

    const lines = dataString.split('\n');

    //Validate the input and return early if not valid
    if(!isValidMedicalData(lines)){ return null; }

    let isParsingMedications = false;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (line === 'Continue') {
            if (isParsingMedications) {
                break; // Stop parsing once second "Continue" line is found
            } else {
                isParsingMedications = true; // Start parsing medical records
                continue;
            }
        }

        if (!isParsingMedications) {
            const patientInfoRegex = /(\d{4} \d{3} \d{3}) - (.+) - (\d{4} [a-zA-Z]{3} \d{2}) - (\w+)/;
            const patientInfoMatch = patientInfoRegex.exec(line);

            if (patientInfoMatch) {
                medicalData.PHN = patientInfoMatch[1];
                medicalData.name = patientInfoMatch[2];
                medicalData.birthDate = patientInfoMatch[3];
                medicalData.gender = patientInfoMatch[4];
            }
        } else {

            let isCurrent;
            let medicationDataLines;

            if (i + CURRENT_MR_LENGTH < lines.length && isDINOrContinue(lines[i + CURRENT_MR_LENGTH])){
                isCurrent = true;
                medicationDataLines = lines.slice(i, i + CURRENT_MR_LENGTH);
            } else if (i + NON_CURRENT_MR_LENGTH < lines.length && isDINOrContinue(lines[i + NON_CURRENT_MR_LENGTH])){
                isCurrent = false;
                medicationDataLines = lines.slice(i, i + NON_CURRENT_MR_LENGTH);
            } else {
                break;
            }

            if (isCurrent) { medicationDataLines.splice(1,2); }

            let medication = parseMedicationLines(isCurrent, medicationDataLines);

            i += (isCurrent ? CURRENT_MR_LENGTH : NON_CURRENT_MR_LENGTH) - 1;

            medicalData.medications.push(medication);
        }
    }

    return medicalData;
}

let result = parseMedicalData(PATIENT_WITH_DECIMAL_AND_TEMP_DRUG);
console.log(result);


let result2 = parseMedicalData(PATIENT_WITH_MCG_AND_DECIMAL);
console.log(result2);